#!/usr/bin/env bash
# of-run: run an OpenFOAM command in batch; loads bashrc so shell functions work
# Usage: of-run <command> [args...]
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: of-run <command> [args...]" >&2
  exit 2
fi

ENGINE="${OPENFOAM_ENGINE:-docker}"
IMAGE="${OPENFOAM_IMAGE:-docker.io/opencfd/openfoam-default}"
TAG="${OPENFOAM_TAG:-2406}"

UIDGID_ARGS=()
if [ "${ENGINE}" = "docker" ] || [ "${ENGINE}" = "podman" ]; then
  UIDGID_ARGS=(--user "$(id -u)":"$(id -g)")
fi

# Bouw het commando (alles na sourcen wordt in dezelfde shell uitgevoerd)
USER_CMD="$*"

exec "${ENGINE}" run --rm \
  "${UIDGID_ARGS[@]}" \
  -v "$PWD:$PWD" -w "$PWD" \
  "${IMAGE}:${TAG}" \
  -- bash -lc '
    # Source de OF-bashrc (robuste zoeklijst voor varianten)
    for p in \
      /usr/lib/openfoam/openfoam*/etc/bashrc \
      /opt/OpenFOAM-*/etc/bashrc \
      /opt/openfoam*/etc/bashrc \
      /usr/share/openfoam*/etc/bashrc \
      /usr/bin/openfoam
    do
      if [ -f "$p" ]; then
        # /usr/bin/openfoam kan een wrapper zijn die zelf sourceâ€™t
        case "$p" in
          */openfoam) . "$p" ;;
          *) . "$p" ;;
        esac
        break
      fi
    done
    exec '"$USER_CMD"'
  '

