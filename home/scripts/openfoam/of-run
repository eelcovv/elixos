#!/usr/bin/env bash
# of-run: run a single OpenFOAM command inside container (non-interactive).
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: of-run <command> [args...]" >&2
  exit 2
fi

ENGINE="${OPENFOAM_ENGINE:-docker}"
IMAGE="${OPENFOAM_IMAGE:-docker.io/opencfd/openfoam-default}"
TAG="${OPENFOAM_TAG:-2406}"

UIDGID_ARGS=(--user "$(id -u)":"$(id -g)")

# Source ESI or Foundation bashrc if present, then run the command
SRC_OF='
if compgen -G "/usr/lib/openfoam/openfoam*/etc/bashrc" > /dev/null; then
  source /usr/lib/openfoam/openfoam*/etc/bashrc
elif compgen -G "/opt/openfoam*/etc/bashrc" > /dev/null; then
  source /opt/openfoam*/etc/bashrc
fi
'

CMD="$*"

exec "${ENGINE}" run --rm -t \
  "${UIDGID_ARGS[@]}" \
  -v "$PWD:$PWD" -w "$PWD" \
  "${IMAGE}:${TAG}" \
  -- bash -c "${SRC_OF}; ${CMD}"

