#!/usr/bin/env bash
# of-run: run a single OpenFOAM command inside the container (non-interactive).
set -euo pipefail

if [[ $# -lt 1 ]]; then
  echo "Usage: of-run <command> [args...]" >&2
  exit 2
fi

ENGINE="${OPENFOAM_ENGINE:-docker}"                           # docker | podman
IMAGE_ENV="${OPENFOAM_IMAGE:-docker.io/opencfd/openfoam-dev}" # mag m√©t of zonder tag
TAG="${OPENFOAM_TAG:-2406}"

# Als IMAGE_ENV al een tag bevat (':'), gebruik die volledig; anders plak :TAG
if [[ "$IMAGE_ENV" == *:* ]]; then
  IMAGE_REF="$IMAGE_ENV"
else
  IMAGE_REF="${IMAGE_ENV}:${TAG}"
fi

# Basis docker/podman args
RUN_ARGS=(
  --rm
  -t
  --user "$(id -u):$(id -g)"
  -v "$PWD:/work" -w /work
  --entrypoint /bin/bash
)

# QoL: map ~/.inputrc (optioneel)
if [[ -f "$HOME/.inputrc" ]]; then
  RUN_ARGS+=(-v "$HOME/.inputrc:/etc/inputrc:ro")
fi

# Bouw inner bash -lc script: source OF-omgeving en voer het commando uit
# We geven het gebruikers-commando als "$@" door via 'bash -lc' trampoline,
# zodat haakjes/quotes als *argumenten* blijven bestaan.
INNER_CMD=$'cd /work\n'\
$'for f in \n'\
$'  /usr/lib/openfoam/openfoam*/etc/bashrc \n'\
$'  /opt/OpenFOAM/OpenFOAM-*/etc/bashrc \n'\
$'  /opt/openfoam*/etc/bashrc \n'\
$'  /usr/lib/openfoam/openfoam*/etc/openfoam \n'\
$'  /opt/OpenFOAM/OpenFOAM-*/etc/openfoam \n'\
$'  /opt/openfoam*/etc/openfoam \n'\
$'do\n'\
$'  [[ -r "$f" ]] && . "$f" && break\n'\
$'done\n'\
$'exec "$@"\n'

# Start container:
#   bash -lc "<source...; exec "$@">" -- bash <user-cmd> <args...>
# Hierdoor ziet de innerlijke shell jouw commando exact zoals je het intypte.
exec "$ENGINE" run "${RUN_ARGS[@]}" "$IMAGE_REF" \
  -lc "$INNER_CMD" -- bash "$@"

