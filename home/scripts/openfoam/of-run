#!/usr/bin/env bash
# of-run: run a single OpenFOAM command inside the container (non-interactive).
set -euo pipefail

if [ $# -lt 1 ]; then
  echo "Usage: of-run <command> [args...]" >&2
  exit 2
fi

ENGINE="${OPENFOAM_ENGINE:-docker}"             # docker or podman
IMAGE="${OPENFOAM_IMAGE:-docker.io/opencfd/openfoam-default}"
TAG="${OPENFOAM_TAG:-2406}"

UIDGID_ARGS=(--user "$(id -u):$(id -g)")

# Snippet: source ESI or Foundation bashrc. No 'set -e' here!
SRC_OF='
for f in /usr/lib/openfoam/openfoam*/etc/bashrc /opt/openfoam*/etc/bashrc; do
  if [ -r "$f" ]; then . "$f"; break; fi
done
'

# Run "$@" after sourcing, preserving quoting
exec "${ENGINE}" run --rm -t \
  "${UIDGID_ARGS[@]}" \
  -v "$PWD:/work" -w /work \
  --entrypoint /bin/bash \
  "${IMAGE}:${TAG}" \
  -c 'cd /work; '"${SRC_OF}"'; "$@"' bash "$@"
