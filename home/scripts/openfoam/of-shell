#!/usr/bin/env bash
# of-shell: Open an interactive OpenFOAM-enabled shell inside a container.
#
# Features:
# - Runs as the current host user (UID/GID mapping).
# - Mounts the current working directory and sets it as workdir.
# - Allocates TTY (-it) for interactive use.
# - Inherits vi-style editing by bind-mounting host ~/.inputrc if present.
#
# Usage:
#   of-shell
#   of-shell <command> [args...]

set -euo pipefail

ENGINE="${OPENFOAM_ENGINE:-docker}"            # docker or podman
IMAGE="${OPENFOAM_IMAGE:-docker.io/opencfd/openfoam-default}"
TAG="${OPENFOAM_TAG:-2406}"

HOST_UID="$(id -u)"
HOST_GID="$(id -g)"

# Build mount array
MOUNTS=(-v "$PWD:$PWD" -w "$PWD")
# If you have a host ~/.inputrc, map it to the container user to enable vi-mode.
if [ -f "$HOME/.inputrc" ]; then
  # container username is "openfoam" in this image
  MOUNTS+=(-v "$HOME/.inputrc:/home/openfoam/.inputrc:ro")
fi

exec "${ENGINE}" run --rm -it \
  --user "${HOST_UID}:${HOST_GID}" \
  "${MOUNTS[@]}" \
  "${IMAGE}:${TAG}" \
  -- bash -i "$@"

