#!/usr/bin/env bash
# of-shell: open an interactive OpenFOAM-enabled shell inside the container.
set -euo pipefail

ENGINE="${OPENFOAM_ENGINE:-docker}"
IMAGE="${OPENFOAM_IMAGE:-docker.io/opencfd/openfoam-default}"
TAG="${OPENFOAM_TAG:-2406}"

HOST_UID="$(id -u)"
HOST_GID="$(id -g)"

MOUNTS=(-v "$PWD:/work" -w /work)

# Snippet: source ESI or Foundation bashrc. No 'set -e' here!
SRC_OF='
for f in /usr/lib/openfoam/openfoam*/etc/bashrc /opt/openfoam*/etc/bashrc; do
  if [ -r "$f" ]; then . "$f"; break; fi
done
'

exec "${ENGINE}" run --rm -it \
  --user "${HOST_UID}:${HOST_GID}" \
  "${MOUNTS[@]}" \
  --entrypoint /bin/bash \
  "${IMAGE}:${TAG}" \
  -c 'cd /work; '"${SRC_OF}"'; exec bash -i'

