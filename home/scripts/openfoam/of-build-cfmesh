#!/usr/bin/env bash
# of-build-cfmesh: Build cfMesh (integration-cfmesh v2406) via of-shell
# and export its tools into a persistent bin dir on the host.
#
# Usage (HOST, not inside container):
#   of-build-cfmesh            # initial clone + build
#   of-build-cfmesh --update   # pull latest + rebuild
#
# Result on host:
#   ~/.local/share/openfoam/cfmesh/bin/{cartesianMesh, surfaceFeatureEdges, surfaceGenerateBoundingBox}

set -euo pipefail

ACTION="clone"
if [[ "${1:-}" == "--update" ]]; then
  ACTION="update"
fi

# Ensure 'of-shell' exists
if ! command -v of-shell >/dev/null 2>&1; then
  echo "[of-build-cfmesh] Error: 'of-shell' not found on PATH." >&2
  exit 1
fi

# Build the inner script as a string WITHOUT using 'read -d ""'
INNER="$(cat <<'EOS'
set -euo pipefail

PERSIST="/home/openfoam/.local/share/openfoam"
SRC_DIR="${PERSIST}/src/integration-cfmesh"
BIN_DIR="${PERSIST}/cfmesh/bin"

mkdir -p "${PERSIST}/src" "${BIN_DIR}"

# Check for git inside the container (dev image usually has it)
if ! command -v git >/dev/null 2>&1; then
  echo "[cfMesh] 'git' is missing in the container."
  echo "[cfMesh] Run on HOST: of-shell-root -c 'apt-get update && apt-get install -y git ca-certificates'"
  exit 2
fi

if [[ "${ACTION}" == "clone" ]]; then
  if [[ ! -d "${SRC_DIR}/.git" ]]; then
    echo "[cfMesh] Cloning integration-cfmesh (branch v2406)…"
    git clone --branch v2406 https://develop.openfoam.com/Community/integration-cfmesh.git "${SRC_DIR}"
  else
    echo "[cfMesh] Repo already exists. Use --update to pull latest."
  fi
else
  if [[ -d "${SRC_DIR}/.git" ]]; then
    echo "[cfMesh] Updating integration-cfmesh…"
    git -C "${SRC_DIR}" pull --ff-only
  else
    echo "[cfMesh] No repo present; cloning fresh."
    git clone --branch v2406 https://develop.openfoam.com/Community/integration-cfmesh.git "${SRC_DIR}"
  fi
fi

echo "[cfMesh] Building…"
cd "${SRC_DIR}"
./Allwmake -j

echo "[cfMesh] Exporting binaries…"
TOOLS=( cartesianMesh surfaceFeatureEdges surfaceGenerateBoundingBox )

for t in "${TOOLS[@]}"; do
  # Prefer PATH (in case wmake installed into FOAM bin dirs)
  if command -v "${t}" >/dev/null 2>&1; then
    cp -vf "$(command -v "${t}")" "${BIN_DIR}/"
    continue
  fi
  # Fallback: search the repo tree for an executable with this name
  FOUND="$(find . -type f -name "${t}" -perm -111 | head -n 1 || true)"
  if [[ -n "${FOUND}" ]]; then
    cp -vf "${FOUND}" "${BIN_DIR}/"
  else
    echo "[cfMesh] Warning: could not locate '${t}' after build."
  fi
done

echo "[cfMesh] Done. Binaries in: ${BIN_DIR}"
EOS
)"

# Export ACTION for the inner script and run via of-shell
export ACTION
of-shell bash -lc "${INNER}"